<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <link rel="icon" href="{{ url_for('static', filename='assets/AnyAI_icon.png') }}">
    <title>AnyAI Video Analysis</title>
    <!-- AnyAI UI Kit -->
    <link rel="stylesheet" href="{{ url_for('static', filename='core/anyai.tokens.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/anyai.components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/anyai.utilities.css') }}">
    <script defer src="{{ url_for('static', filename='core/anyai.js') }}"></script>
    <style>
        body {
            /* Add some extra padding at the bottom for spacing */
            padding-bottom: var(--anyai-space-10);
        }
        #log-container {
            height: 400px;
            background-color: var(--anyai-bg-subtle);
            border: 1px solid var(--anyai-border);
            border-radius: var(--anyai-radius-2);
            padding: var(--anyai-space-4);
            overflow-y: scroll;
            font-family: var(--anyai-font-mono);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: var(--anyai-fs-2);
            color: var(--anyai-text);
        }
        .logo-inline { 
            height: 28px; 
            vertical-align: middle; 
        }
    </style>
</head>
<body>
    <header class="anyai-header">
        <a class="brand" href="#" aria-label="AnyAI Home">
            <img src="{{ url_for('static', filename='assets/AnyAI_logo.png') }}" alt="AnyAI Logo">
            <span>AnyAI Video Analysis</span>
        </a>
        <nav class="nav">
            <button class="btn btn-ghost" data-action="toggle-theme" title="Toggle light/dark theme">Theme</button>
        </nav>
    </header>

    <main class="container mt-5">
        <div class="card">
            <div class="card-body">
                <h1 style="font-size: var(--anyai-fs-7); margin-bottom: var(--anyai-space-2);">Video Analysis Setup</h1>
                <p class="text-subtle" style="margin-bottom: var(--anyai-space-6);">Configure the analysis by providing the Google Sheet details below.</p>

                <form id="runner-form">
                    <div class="field">
                        <label for="sheet-url">Google Spreadsheet URL</label>
                        <input type="url" class="input" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." required>
                    </div>

                    <div class="grid grid-2">
                        <div class="field">
                            <label for="source-sheet-name">Source Sheet Name</label>
                            <input type="text" class="input" id="source-sheet-name" value="Sheet1">
                        </div>
                        <div class="field">
                            <label for="video-col-letter">Video URL Column</label>
                            <input type="text" class="input" id="video-col-letter" value="B">
                        </div>
                        <div class="field">
                            <label for="output-sheet-name">Output Sheet Name (Optional)</label>
                            <input type="text" class="input" id="output-sheet-name" placeholder="Default: Source Sheet">
                        </div>
                        <div class="field">
                            <label for="output-col-letter">Output Column</label>
                            <input type="text" class="input" id="output-col-letter" value="G">
                        </div>
                        <div class="field">
                            <label for="start-row">Start Row</label>
                            <input type="number" class="input" id="start-row" value="2" min="2">
                        </div>
                        <div class="field">
                            <label for="end-row">End Row (Optional)</label>
                            <input type="number" class="input" id="end-row" placeholder="Process until the end">
                        </div>
                         <div class="field">
                            <label for="workers">Batch Size</label>
                            <input type="number" class="input" id="workers" value="5" min="1" max="50">
                        </div>
                    </div>

                    <div class="field mt-5">
                        <label>Gemini Model</label>
                        <div class="card" style="background: var(--anyai-bg-subtle);">
                            <div class="card-body">
                                <div class="row" style="gap: var(--anyai-space-5);">
                                    <label class="row" style="font-weight: normal; cursor: pointer;">
                                        <input type="radio" name="model-name" id="model-flash" value="gemini-1.5-flash" checked>
                                        Flash (Faster)
                                    </label>
                                    <label class="row" style="font-weight: normal; cursor: pointer;">
                                        <input type="radio" name="model-name" id="model-pro" value="gemini-1.5-pro">
                                        Pro (Higher Quality)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 row">
                        <button type="submit" class="btn btn-primary" id="run-button">Run Analysis</button>
                        <button type="button" class="btn btn-outline" id="stop-button" disabled>Stop</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-5">
            <h2>Execution Log</h2>
            <div id="log-container"><span class="text-subtle">Awaiting configuration...</span></div>
        </div>
    </main>

    <script>
        // --- All the original JavaScript is preserved here ---
        const form = document.getElementById('runner-form');
        const logContainer = document.getElementById('log-container');
        const runButton = document.getElementById('run-button');
        const stopButton = document.getElementById('stop-button');
        let currentProcessId = null;

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const timestampSpan = `<span class="text-subtle">[${timestamp}]</span>`;
            const messageSpan = isError ? `<span class="text-danger">${message}</span>` : `<span>${message}</span>`;
            
            const line = document.createElement('div');
            line.innerHTML = `${timestampSpan} ${messageSpan}`;
            logContainer.appendChild(line);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        stopButton.addEventListener('click', async () => {
            if (!currentProcessId) {
                log('-> No active analysis to stop.', true);
                return;
            }
            log('-> Sending stop signal...');
            stopButton.disabled = true;
            try {
                await fetch('/stop-analysis', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ process_id: currentProcessId }),
                });
                log('-> Stop signal sent. The analysis has been terminated.');
            } catch (error) {
                log(`-> Error sending stop signal: ${error}`, true);
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const formData = {
                sheet_url: document.getElementById('sheet-url').value,
                source_sheet_name: document.getElementById('source-sheet-name').value,
                video_col_letter: document.getElementById('video-col-letter').value,
                output_sheet_name: document.getElementById('output-sheet-name').value,
                output_col_letter: document.getElementById('output-col-letter').value,
                start_row: document.getElementById('start-row').value,
                end_row: document.getElementById('end-row').value,
                model_name: document.querySelector('input[name="model-name"]:checked').value,
                workers: document.getElementById('workers').value,
            };

            log('-> Analysis request sent. Waiting for logs...');
            runButton.disabled = true;
            runButton.textContent = 'Running...';
            stopButton.disabled = false;

            try {
                const response = await fetch('/run-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();

                if (!response.ok) {
                    log(`Error starting analysis: ${result.error}`, true);
                    finalizeUI();
                    return;
                }
                
                currentProcessId = result.process_id;
                log(`-> Backend process started successfully (ID: ${currentProcessId}). Streaming logs...`);
                
                const eventSource = new EventSource(`/stream-logs?process_id=${currentProcessId}`);

                eventSource.onmessage = function(event) {
                    log(event.data);
                };

                eventSource.addEventListener('error', function(event) {
                    if (event.data) {
                        log(`-> ${event.data}`, true);
                    } else {
                        log('-> Log stream connection lost. The process may have finished or a network error occurred.', true);
                    }
                    eventSource.close();
                    finalizeUI();
                });
                
                eventSource.addEventListener('complete', function(event) {
                    log(`-> ${event.data}`);
                    eventSource.close();
                    finalizeUI();
                });

            } catch (error) {
                log(`Network or server error: ${error}`, true);
                finalizeUI();
            }
        });

        function finalizeUI() {
            runButton.disabled = false;
            runButton.textContent = 'Run Analysis';
            stopButton.disabled = true;
            currentProcessId = null;
        }
    </script>
</body>
</html>
