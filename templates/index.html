<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyAI Video Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 4.5rem;
            /* The main page background is now white, making the gray box stand out. */
        }
        #log-container {
            height: 400px;
            background-color: #f8f9fa; /* Light background to match reference */
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            overflow-y: scroll;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9em;
            color: #212529; /* Dark text for light background */
        }
        .form-control, .form-select {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">AnyAI Video Analysis</a>
        </div>
    </nav>

    <main class="container">
        <div class="bg-light p-5 rounded">
            <h1>AnyAI Video言語化(Local)</h1>
            <p class="lead">'local_video'上に保存してある動画を言語化します。</p>
            <form id="runner-form">
                
                <div class="mb-3">
                    <label for="sheet-url" class="form-label">Google Spreadsheet URL</label>
                    <input type="url" class="form-control" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." required>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="source-sheet-name" class="form-label">Source Sheet Name</label>
                        <input type="text" class="form-control" id="source-sheet-name" value="Sheet1">
                    </div>
                    <div class="col-md-6">
                        <label for="video-col-letter" class="form-label">Video Column</label>
                        <input type="text" class="form-control" id="video-col-letter" value="B">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="output-sheet-name" class="form-label">Output Sheet Name</label>
                        <input type="text" class="form-control" id="output-sheet-name" placeholder="Default: Source Sheet">
                    </div>
                    <div class="col-md-6">
                        <label for="output-col-letter" class="form-label">Output Column</label>
                        <input type="text" class="form-control" id="output-col-letter" value="G">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="start-row" class="form-label">Start Row</label>
                        <input type="number" class="form-control" id="start-row" value="2" min="2">
                    </div>
                    <div class="col-md-6">
                        <label for="end-row" class="form-label">End Row</label>
                        <input type="number" class="form-control" id="end-row" placeholder="Process until the end">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="model-name" class="form-label">Gemini Model</label>
                        <select class="form-select" id="model-name">
                            <option value="gemini-1.5-flash" selected>Flash (Faster)</option>
                            <option value="gemini-1.5-pro">Pro (Higher Quality)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="workers" class="form-label">Batch</label>
                        <input type="number" class="form-control" id="workers" value="5" min="1" max="50">
                    </div>
                </div>

                <div>
                    <button type="submit" class="btn btn-primary" id="run-button">Run Analysis</button>
                    <button type="button" class="btn btn-secondary" id="stop-button" disabled>Stop</button>
                </div>
            </form>
        </div>

        <div class="mt-4">
            <h2>Execution Log</h2>
            <div id="log-container"><span style="color: #6c757d;">Awaiting configuration...</span></div>
        </div>
    </main>

    <script>
        const form = document.getElementById('runner-form');
        const logContainer = document.getElementById('log-container');
        const runButton = document.getElementById('run-button');
        const stopButton = document.getElementById('stop-button');

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const timestampColor = '#6c757d'; // Muted gray for timestamp
            const messageColor = isError ? '#dc3545' : '#212529'; // Red for error, dark for normal
            
            const line = document.createElement('div');
            line.innerHTML = `<span style="color: ${timestampColor};">[${timestamp}]</span> <span style="color: ${messageColor};">${message}</span>`;
            logContainer.appendChild(line);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        stopButton.addEventListener('click', async () => {
            log('-> Sending stop signal...');
            stopButton.disabled = true;
            try {
                await fetch('/stop-analysis', { method: 'POST' });
                log('-> Stop signal sent. The script will halt after the current row is finished.');
            } catch (error) {
                log(`-> Error sending stop signal: ${error}`, true);
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const formData = {
                sheet_url: document.getElementById('sheet-url').value,
                source_sheet_name: document.getElementById('source-sheet-name').value,
                video_col_letter: document.getElementById('video-col-letter').value,
                output_sheet_name: document.getElementById('output-sheet-name').value,
                output_col_letter: document.getElementById('output-col-letter').value,
                start_row: document.getElementById('start-row').value,
                end_row: document.getElementById('end-row').value,
                model_name: document.getElementById('model-name').value,
                workers: document.getElementById('workers').value,
            };

            logContainer.innerHTML = '';
            log('-> Starting analysis...');
            runButton.disabled = true;
            runButton.textContent = 'Running...';
            stopButton.disabled = false;

            try {
                const response = await fetch('/run-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    log(`HTTP Error: ${response.status} - ${errorData.error}`, true);
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6).trim();
                            if (message) {
                                log(message, message.includes('ERROR') || message.includes('FATAL'));
                            }
                        }
                    }
                }

            } catch (error) {
                log(`Network or server error: ${error}`, true);
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'Run Analysis';
                stopButton.disabled = true;
            }
        });
    </script>
</body>
</html>